# CI/CD Pipeline Documentation

**Platform:** GitHub Actions
**Configuration:** [.github/workflows/test.yml](../.github/workflows/test.yml)
**Node Version:** 25

---

## Pipeline Overview

The CI pipeline runs automatically on:
- **Push** to `main` or `develop` branches
- **Pull requests** targeting `main` or `develop`
- **Weekly schedule** (Monday 6 AM UTC) for burn-in stability checks

### Pipeline Stages

| Stage | Duration | Trigger | Purpose |
|-------|----------|---------|---------|
| **Lint** | <2 min | All | TypeScript type check, ESLint |
| **Test** | <5 min | All | Unit/integration tests with coverage |
| **Burn-in** | <15 min | PR + Schedule | Flaky test detection (10 iterations) |
| **Build Check** | <10 min | PR to main | Expo config validation |
| **Summary** | <1 min | All | Pipeline status report |

---

## Running Locally

### Mirror Full CI Pipeline

```bash
./scripts/ci-local.sh
```

This runs all CI stages locally with reduced burn-in iterations (3 vs 10).

### Run Burn-in Only

```bash
# Default: 10 iterations
./scripts/burn-in.sh

# Quick check: 3 iterations
./scripts/burn-in.sh 3

# Thorough: 100 iterations
./scripts/burn-in.sh 100
```

### Run Tests with Coverage

```bash
npm test -- --coverage
```

---

## Debugging Failed CI Runs

### 1. Check the Summary

Look at the "Pipeline Summary" job for overall status.

### 2. Download Artifacts

Failed runs upload:
- `test-results/` - JUnit XML reports
- `coverage/` - Coverage reports

### 3. Common Failures

**Lint failures:**
- Type errors: Run `npx tsc --noEmit` locally
- ESLint: Run `npm run lint` locally

**Test failures:**
- Check test output for assertion errors
- Run specific test: `npm test -- --testNamePattern="test name"`

**Burn-in failures:**
- Tests are flaky (non-deterministic)
- Run `./scripts/burn-in.sh` locally to reproduce
- Fix race conditions, timing issues, or shared state

### 4. Run Tests in Sequence

If parallel execution causes issues:

```bash
npm test -- --runInBand
```

---

## Configuration

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `CI` | Auto-set | Enables CI mode in Jest |
| `EXPO_TOKEN` | Optional | For EAS build validation |

### Secrets

Configure in GitHub repository settings:

| Secret | Required | Purpose |
|--------|----------|---------|
| `EXPO_TOKEN` | Optional | Expo EAS authentication |
| `CODECOV_TOKEN` | Optional | Coverage upload |

---

## Performance Optimization

### Caching

The pipeline caches:
- npm dependencies (keyed by package-lock.json hash)

### Concurrency

```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```

This cancels in-progress runs when a new commit is pushed.

### Timeouts

| Job | Timeout |
|-----|---------|
| Lint | 10 min |
| Test | 15 min |
| Burn-in | 30 min |
| Build Check | 10 min |

---

## Badge URLs

Add these to your README:

```markdown
![Tests](https://github.com/JustForCodin/poc-didit-camera-app/actions/workflows/test.yml/badge.svg)
```

---

## Troubleshooting

### "Tests pass locally but fail in CI"

1. Check Node version matches (CI uses Node 25)
2. Run tests with `CI=true npm test`
3. Check for environment-dependent code

### "Burn-in detects flaky tests"

1. Run `./scripts/burn-in.sh` locally
2. Look for:
   - `setTimeout`/`setInterval` without proper cleanup
   - Shared state between tests
   - Missing `await` on async operations
   - Random data without seeds

### "Type check fails but VSCode shows no errors"

1. Ensure VSCode uses workspace TypeScript
2. Run `npx tsc --noEmit` in terminal
3. Check for different `tsconfig.json` settings

---

## Maintenance

### Updating Node Version

1. Update `NODE_VERSION` in `.github/workflows/test.yml`
2. Update `.nvmrc` if you use it locally

### Adding New Jobs

Follow the existing pattern:

```yaml
new-job:
  name: New Job Name
  runs-on: ubuntu-latest
  timeout-minutes: 10
  needs: [prerequisite-job]

  steps:
    - uses: actions/checkout@v4
    # ... steps
```

---

**Generated by:** BMad TEA Agent - CI Pipeline Module
**Date:** 2025-12-13
