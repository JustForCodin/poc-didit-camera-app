# GitHub Actions CI Pipeline for poc-didit-camera-app
# React Native/Expo application with Jest unit/integration testing
#
# Pipeline Stages:
# 1. lint - Code quality checks (TypeScript, ESLint)
# 2. test - Unit/integration tests with coverage
# 3. burn-in - Flaky test detection (PR only)
#
# Performance targets:
# - Lint: <2 min
# - Test: <5 min
# - Burn-in: <15 min
# - Total: <20 min

name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  # Weekly burn-in run for flaky test detection
  schedule:
    - cron: '0 6 * * 1' # Monday 6 AM UTC

# Cancel in-progress runs on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '25'

# Required permissions for test reporting and PR checks
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # ============================================
  # Stage 1: Lint - Code Quality Checks
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npx tsc --noEmit
        continue-on-error: true # Don't fail on type errors in early stages

      - name: Run ESLint
        run: npm run lint --if-present
        continue-on-error: true # Don't fail if lint script not yet configured

  # ============================================
  # Stage 2: Test - Unit & Integration Tests
  # ============================================
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm test -- --ci --coverage --reporters=default --reporters=jest-junit
        env:
          CI: true
          JEST_JUNIT_OUTPUT_DIR: test-results
          JEST_JUNIT_OUTPUT_NAME: junit.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results/
            coverage/
          retention-days: 30

      - name: Test Report Summary
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Jest Tests
          path: test-results/junit.xml
          reporter: jest-junit
          fail-on-error: false
        continue-on-error: true  # Don't fail pipeline if reporter lacks permissions

  # ============================================
  # Stage 3: Burn-in - Flaky Test Detection
  # ============================================
  burn-in:
    name: Flaky Test Detection
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: test
    # Only run burn-in on PRs to main/develop or scheduled runs
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run burn-in loop (10 iterations)
        run: |
          echo "ðŸ”¥ Starting burn-in test loop..."
          FAILURES=0

          for i in {1..10}; do
            echo ""
            echo "=========================================="
            echo "ðŸ”¥ Burn-in iteration $i/10"
            echo "=========================================="

            if npm test -- --ci; then
              echo "âœ… Iteration $i passed"
            else
              echo "âŒ Iteration $i FAILED"
              FAILURES=$((FAILURES + 1))
            fi
          done

          echo ""
          echo "=========================================="
          echo "ðŸ“Š Burn-in Summary"
          echo "=========================================="
          echo "Total iterations: 10"
          echo "Failures: $FAILURES"

          if [ $FAILURES -gt 0 ]; then
            echo ""
            echo "âŒ FLAKY TESTS DETECTED!"
            echo "Tests failed $FAILURES out of 10 iterations."
            echo "This indicates non-deterministic behavior."
            echo ""
            echo "Common causes:"
            echo "  - Race conditions"
            echo "  - Timing dependencies"
            echo "  - Shared state between tests"
            echo "  - External service dependencies"
            exit 1
          else
            echo ""
            echo "âœ… All 10 iterations passed - tests are stable!"
          fi
        env:
          CI: true

      - name: Upload burn-in failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: burn-in-failures
          path: |
            test-results/
            coverage/
          retention-days: 30

  # ============================================
  # Stage 4: EAS Build Check (Optional)
  # ============================================
  build-check:
    name: Expo Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: test
    # Only run on PRs to main
    if: github.event_name == 'pull_request' && github.base_ref == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true # Don't fail if EXPO_TOKEN not configured

      - name: Validate app.json/app.config.ts
        run: |
          if [ -f "app.config.ts" ] || [ -f "app.config.js" ] || [ -f "app.json" ]; then
            echo "âœ… Expo config found"
            npx expo config --type public || echo "Config validation skipped"
          else
            echo "âš ï¸ No Expo config found - this is expected before project initialization"
          fi
        continue-on-error: true

  # ============================================
  # Pipeline Summary
  # ============================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: always()

    steps:
      - name: Check pipeline status
        run: |
          echo "ðŸ“Š Pipeline Summary"
          echo "==================="
          echo ""
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo ""

          if [ "${{ needs.test.result }}" == "failure" ]; then
            echo "âŒ Pipeline failed - tests did not pass"
            exit 1
          elif [ "${{ needs.lint.result }}" == "failure" ]; then
            echo "âš ï¸ Lint checks failed (non-blocking)"
          fi

          echo "âœ… Pipeline completed successfully!"
